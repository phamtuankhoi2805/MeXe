<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>
    
    <title th:text="${product != null ? product.name : 'Sản phẩm'}">Chi tiết sản phẩm</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" th:href="@{/css/trang-chu.css}">
    <link rel="stylesheet" th:href="@{/css/chi-tiet-san-pham.css}">
</head>
<body>

    <!-- Navigation -->
    <div th:replace="~{fragments/dieu-huong :: thanhDieuHuong}"></div>

    <main th:if="${product != null}">
        <!-- 1. HERO BANNER SECTION -->
        <section class="vf-hero-section">
            <div class="vf-container hero-content">
                <div class="hero-text animate-slide-in-left">
                    <h2 class="hero-subtitle" th:text="${product.name}">EVO 200 LITE</h2>
                    <h1 class="hero-title">VẬN HÀNH BỀN BỈ,<br>CHINH PHỤC<br>MỌI HÀNH TRÌNH</h1>
                    <div class="hero-colors">
                        <span>Đổi màu đa sắc</span>
                        <div class="color-dots-preview">
                            <span style="background:#E6E6E6"></span>
                            <span style="background:#FFC107"></span>
                            <span style="background:#1A1A1A"></span>
                            <span style="background:#4A148C"></span>
                        </div>
                    </div>
                </div>
                <div class="hero-image animate-fade-in delay-300">
                    <!-- Hiển thị 3 xe xếp chồng nhau như thiết kế (giả lập bằng CSS) -->
                    <img th:src="${product.image}" alt="VinFast Scooter" class="hero-scooter">
                </div>
            </div>
        </section>

        <!-- 2. HIGHLIGHT SPECS SECTION -->
        <section class="vf-highlight-section">
            <div class="vf-container highlight-grid">
                <div class="highlight-image animate-scale-in">
                    <img th:src="${product.image}" alt="Góc nghiêng sau">
                </div>
                <div class="highlight-stats animate-slide-in-right">
                    <div class="stat-item">
                        <h3 class="stat-value">70 km/h*</h3>
                        <p class="stat-label">Tốc độ tối đa</p>
                    </div>
                    <div class="stat-item">
                        <h3 class="stat-value">~203 km/1 lần sạc*</h3>
                        <p class="stat-label">Quãng đường di chuyển</p>
                    </div>
                    <div class="stat-item">
                        <h3 class="stat-value">22 lít</h3>
                        <p class="stat-label">Thể tích cốp</p>
                    </div>
                    <p class="disclaimer">*Theo điều kiện tiêu chuẩn của VinFast</p>
                </div>
            </div>
        </section>

        <!-- 3. COLOR SELECTION & BUY SECTION (Core Feature) -->
        <section class="vf-color-section" id="buy-section">
            <div class="vf-container">
                <h2 class="section-title text-center">Đa dạng tùy chọn màu sắc</h2>
                <p class="product-price text-center">
                    Giá bán: <strong th:text="${#numbers.formatDecimal(product.finalPrice, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">18.000.000 VNĐ</strong>
                </p>

                <!-- Main Rotating Image -->
                <div class="color-viewer animate-fade-in">
                    <img id="mainProductImage" th:src="${product.image}" th:alt="${product.name}" class="viewer-image">
                </div>

                <!-- Color Controls -->
                <div class="color-controls">
                    <div class="color-options" th:if="${productColors != null && !productColors.isEmpty()}">
                        <!-- Render color options dynamically -->
                        <label th:each="pColor, iterStat : ${productColors}" 
                               class="color-radio" 
                               th:title="${pColor.color.name}">
                            <input type="radio" name="colorId" th:value="${pColor.color.id}" 
                                   th:checked="${iterStat.first}"
                                   th:data-image-url="${pColor.color.image != null ? pColor.color.image : product.image}"
                                   onchange="updateSelectedColor(this)">
                            <span class="checkmark" 
                                  th:style="'background-color:' + ${pColor.color.hexCode}"></span>
                        </label>
                    </div>
                    <div class="color-options" th:if="${productColors == null || productColors.isEmpty()}">
                         <p>Đang cập nhật màu sắc...</p>
                    </div>
                    
                    <!-- Quantity & Buy Button -->
                    <div class="action-buttons-container">
                        <div class="quantity-control">
                            <label for="qtyInput">Số lượng:</label>
                            <div class="qty-input-group">
                                <button class="qty-btn minus" onclick="updateQuantity(-1)">-</button>
                                <input type="number" id="qtyInput" value="1" min="1" max="10" readonly>
                                <button class="qty-btn plus" onclick="updateQuantity(1)">+</button>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-vf-primary btn-add-cart" 
                                    th:data-product-id="${product != null ? product.id : null}"
                                    th:data-product-slug="${product != null ? product.slug : null}"
                                    onclick="addToCartAndGoToCart(this)">
                                MUA NGAY
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. LIFESTYLE / EXPERIENCE SECTION -->
        <section class="vf-experience-section">
            <div class="vf-container experience-content">
                <div class="exp-image animate-fade-in">
                    <img th:src="${productImages != null && !productImages.isEmpty() ? productImages[0] : product.image}" alt="Lifestyle">
                </div>
                <div class="exp-text animate-slide-in-right">
                    <h2>Trải nghiệm hành trình di chuyển lên tới 203km trong một lần sạc*.</h2>
                    <p>Công nghệ pin LFP tiên tiến giúp xe vận hành bền bỉ, an toàn và tiết kiệm năng lượng tối đa.</p>
                    <a href="#" class="link-arrow">Khám phá thêm &rarr;</a>
                </div>
            </div>
        </section>

        <!-- 5. TECH SPECS SECTION -->
        <section class="vf-specs-section">
            <div class="vf-container">
                <h2 class="section-title text-center">Thông số kỹ thuật</h2>
                
                <div class="specs-table-wrapper animate-fade-in-up">
                    <table class="vf-specs-table">
                        <tbody>
                            <tr>
                                <td>Dài x Rộng x Cao</td>
                                <td>1804 x 683 x 1127 mm</td>
                            </tr>
                            <tr>
                                <td>Khoảng sáng gầm xe</td>
                                <td>135 mm</td>
                            </tr>
                            <tr>
                                <td>Chiều cao yên</td>
                                <td>750 mm</td>
                            </tr>
                            <tr>
                                <td>Thể tích cốp</td>
                                <td>22 Lít</td>
                            </tr>
                            <tr>
                                <td>Loại động cơ</td>
                                <td>Inhub</td>
                            </tr>
                            <tr>
                                <td>Công suất danh định</td>
                                <td>1500 W</td>
                            </tr>
                             <tr>
                                <td>Loại pin</td>
                                <td>LFP - 1 pin</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="specs-actions">
                    <button class="btn-vf-outline">TẢI BROCHURE</button>
                    <button class="btn-vf-primary" onclick="document.getElementById('buy-section').scrollIntoView({behavior: 'smooth'})">ĐẶT MUA NGAY</button>
                </div>
            </div>
        </section>

        <!-- 6. CONSULTATION FORM SECTION -->
        <section class="vf-consult-section">
            <div class="vf-container">
                <h2 class="section-title text-center">ĐĂNG KÝ TƯ VẤN</h2>
                <p class="text-center">Vui lòng điền thông tin để nhận tư vấn chi tiết</p>
                
                <form class="vf-consult-form animate-fade-in-up">
                    <div class="form-row">
                        <input type="text" placeholder="Họ và tên *" class="vf-input">
                    </div>
                    <div class="form-row">
                        <input type="tel" placeholder="Số điện thoại *" class="vf-input">
                    </div>
                    <div class="form-row">
                        <input type="email" placeholder="Email" class="vf-input">
                    </div>
                    <div class="form-row">
                        <select class="vf-select">
                            <option>Tỉnh/Thành phố *</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <select class="vf-select">
                            <option>Quận/Huyện *</option>
                        </select>
                    </div>
                    <div class="form-row checkbox-row">
                        <label>
                            <input type="checkbox"> Tôi cam kết các thông tin đã cung cấp là chính xác...
                        </label>
                    </div>
                    <button type="submit" class="btn-vf-submit">ĐĂNG KÝ NGAY</button>
                </form>
            </div>
        </section>

    </main>

    <div th:if="${product == null}" class="vf-container error-message">
        <h1>Sản phẩm không tồn tại</h1>
        <a href="/" class="btn-vf-primary">Về trang chủ</a>
    </div>

    <!-- Footer -->
    <div th:replace="~{fragments/chan-trang :: chanTrang}"></div>

    <!-- Scripts -->
    <script th:src="@{/js/cart.js}"></script>
    <script th:src="@{/js/dieu-huong.js}"></script>
    <script th:inline="javascript">
        // Set global variables for cart.js
        window.isAuthenticated = /*[[${#authentication != null && #authentication.isAuthenticated() && #authentication.name != 'anonymousUser'}]]*/ false;
        window.currentUserId = /*[[${currentUserId != null ? currentUserId : null}]]*/ null;
        window.productId = /*[[${product != null && product.id != null ? product.id : null}]]*/ null;
        window.productSlug = /*[[${product != null && product.slug != null ? product.slug : null}]]*/ null;
        
        // Animation Observer
        const observerOptions = { threshold: 0.15 };
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, observerOptions);

        document.addEventListener('DOMContentLoaded', () => {
            const animatedElements = document.querySelectorAll('.animate-fade-in, .animate-fade-in-up, .animate-slide-in-left, .animate-slide-in-right, .animate-scale-in');
            animatedElements.forEach(el => observer.observe(el));
        });
        
        // Logic chọn màu
        function updateSelectedColor(radioInput) {
            var imageUrl = radioInput.getAttribute('data-image-url');
            if (imageUrl && imageUrl !== 'null') {
                const mainImage = document.getElementById('mainProductImage');
                // Hiệu ứng fade nhẹ
                mainImage.style.opacity = '0.5';
                setTimeout(() => {
                    mainImage.src = imageUrl;
                    mainImage.style.opacity = '1';
                }, 200);
            }
        }

        // Update Quantity
        function updateQuantity(change) {
            const input = document.getElementById('qtyInput');
            let newValue = parseInt(input.value) + change;
            if (newValue < 1) newValue = 1;
            if (newValue > 10) newValue = 10; // Giới hạn max 10
            input.value = newValue;
        }

        // Add to Cart and Go to Cart Page
        function addToCartAndGoToCart(button) {
            // Lấy productId từ nhiều nguồn (ưu tiên theo thứ tự)
            var productId = null;
            
            // 1. Lấy từ button data attribute
            if (button && button.dataset && button.dataset.productId) {
                productId = parseInt(button.dataset.productId);
            }
            
            // 2. Lấy từ button element nếu không có trong parameter
            if (!productId && button) {
                const btn = button.closest ? button : document.querySelector('.btn-add-cart');
                if (btn && btn.dataset && btn.dataset.productId) {
                    productId = parseInt(btn.dataset.productId);
                }
            }
            
            // 3. Lấy từ global variable (window.productId)
            if (!productId && window.productId) {
                productId = parseInt(window.productId);
            }
            
            // 4. Fallback: Lấy từ button selector
            if (!productId) {
                const buyButton = document.querySelector('.btn-add-cart[data-product-id]');
                if (buyButton && buyButton.dataset && buyButton.dataset.productId) {
                    productId = parseInt(buyButton.dataset.productId);
                }
            }
            
            if (!productId || isNaN(productId)) {
                 console.error("Product ID not found. Button:", button);
                 alert("Lỗi dữ liệu sản phẩm. Vui lòng tải lại trang.");
                 return;
            }

            var quantity = 1;
            const qtyInput = document.getElementById('qtyInput');
            if (qtyInput) {
                const qtyValue = parseInt(qtyInput.value);
                if (!isNaN(qtyValue) && qtyValue > 0) {
                    quantity = qtyValue;
                }
            }

            var userId = window.currentUserId;
            var isAuthenticated = window.isAuthenticated;
            
            // Get selected color
            var colorId = null;
            var colorSelect = document.querySelector('input[name="colorId"]:checked');
            
            // Nếu sản phẩm có màu (có input radio) mà chưa chọn -> yêu cầu chọn
            var hasColorOptions = document.querySelector('input[name="colorId"]');
            
            if (colorSelect && colorSelect.value) {
                const colorValue = parseInt(colorSelect.value);
                if (!isNaN(colorValue)) {
                    colorId = colorValue;
                }
            } else if (hasColorOptions) {
                alert("Vui lòng chọn màu sắc");
                // Scroll to color section
                const colorControls = hasColorOptions.closest('.color-controls');
                if (colorControls) {
                    colorControls.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight effect
                    colorControls.style.animation = 'pulse 0.5s 2';
                }
                return;
            }
            
            console.log('Adding to cart:', { productId, colorId, quantity, userId, isAuthenticated });

            // Kiểm tra lại trước khi gọi API
            if (!productId || isNaN(productId) || !quantity || quantity <= 0) {
                alert("Thông tin sản phẩm không hợp lệ. Vui lòng tải lại trang.");
                console.error('Invalid product data:', { productId, quantity });
                return;
            }

            // Kiểm tra window.addToCart có tồn tại không
            if (typeof window.addToCart !== 'function') {
                // Đợi một chút để cart.js load xong (nếu chưa load)
                console.warn('window.addToCart not found, waiting for cart.js to load...');
                let retryCount = 0;
                const maxRetries = 10;
                const checkInterval = setInterval(() => {
                    retryCount++;
                    if (typeof window.addToCart === 'function') {
                        clearInterval(checkInterval);
                        // Gọi lại function sau khi cart.js đã load
                        setTimeout(() => addToCartAndGoToCart(button), 100);
                    } else if (retryCount >= maxRetries) {
                        clearInterval(checkInterval);
                        alert("Lỗi hệ thống: Không thể tải module giỏ hàng. Vui lòng tải lại trang.");
                        console.error('window.addToCart is still not available after retries');
                        if (button) {
                            button.disabled = false;
                            button.textContent = 'MUA NGAY';
                        }
                    }
                }, 100);
                return;
            }

            // Disable button while processing
            if (button) {
                button.disabled = true;
                const originalText = button.textContent;
                button.textContent = 'Đang xử lý...';
                
                // Re-enable button after 5 seconds if error (tăng thời gian chờ)
                setTimeout(() => {
                    if (button && button.disabled) {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                }, 5000);
            }

            // Gọi hàm addToCart từ cart.js
            window.addToCart(productId, colorId, quantity, userId, isAuthenticated)
                .then(() => {
                    if (button) {
                        button.textContent = '✓ Đã thêm!';
                        button.style.background = 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)';
                    }
                    setTimeout(() => {
                        window.location.href = '/gio-hang';
                    }, 500);
                })
                .catch(err => {
                    console.error('Error adding to cart:', err);
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'MUA NGAY';
                        button.style.background = '';
                    }
                    alert("Có lỗi khi thêm vào giỏ hàng: " + (err.message || err));
                });
        }
    </script>

</body>
</html>
