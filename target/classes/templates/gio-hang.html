<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Giỏ hàng VinFast</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/trang-chu.css}" href="/css/trang-chu.css">
    <link rel="stylesheet" th:href="@{/css/gio-hang.css}" href="/css/gio-hang.css">
</head>
<body>

<div th:replace="~{fragments/dieu-huong :: thanhDieuHuong}"></div>

<main class="cart-page">
    <section class="vf-container cart-hero" data-animate>
        <div>
            <p class="eyebrow">Giỏ hàng VinFast</p>
            <h1>Hoàn tất đơn mua xe nhanh chóng</h1>
            <p>Cung cấp thông tin liên hệ và địa chỉ giao xe, VinFast sẽ gửi hợp đồng điện tử để bạn xác nhận trong vòng ít phút.</p>
        </div>
    </section>

    <section class="vf-container cart-layout" data-animate>
        <div class="cart-items">
            <header>
                <h2>Danh sách sản phẩm</h2>
                <span th:text="${cartItems != null and !cartItems.empty} ? ${cartItems.size()} + ' sản phẩm' : '0 sản phẩm'">0 sản phẩm</span>
            </header>
            
            <!-- Hiển thị cart items từ database nếu user đã đăng nhập -->
            <article th:each="item : ${cartItems}" class="cart-item">
                <img th:src="${item.product.image != null and !item.product.image.isEmpty()} ? 
                               (${item.product.image.startsWith('/')} ? @{${item.product.image}} : @{/image/{img}(img=${item.product.image})}) 
                               : @{/image/evo200.jpg}" 
                     src="/image/evo200.jpg" 
                     th:alt="${item.product.name}">
                <div class="cart-item__info">
                    <h3 th:text="${item.product.name}">Tên sản phẩm</h3>
                    <p th:if="${item.color != null}" th:text="'Màu: ' + ${item.color.name}">Màu</p>
                    <label>Số lượng
                        <input type="number" min="1" th:value="${item.quantity}" 
                               th:onchange="'updateCartQuantity(' + ${item.id} + ', this.value)'">
                    </label>
                </div>
                <div>
                    <strong th:text="${#numbers.formatDecimal(item.product.finalPrice * item.quantity, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</strong>
                    <button th:onclick="'removeFromCart(' + ${item.id} + ')'" style="margin-top: 8px; padding: 4px 8px; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">Xóa</button>
                </div>
            </article>
            
            <!-- Thông báo nếu giỏ hàng trống -->
            <div th:if="${cartItems == null or cartItems.empty}" class="cart-empty" style="text-align: center; padding: 40px; color: #888;">
                <p>Giỏ hàng của bạn đang trống.</p>
                <a href="/" class="vf-btn vf-btn--primary" style="margin-top: 16px; display: inline-block;">Tiếp tục mua sắm</a>
            </div>
            
            <div class="cart-note" th:if="${cartItems != null and !cartItems.empty}">
                <p>Giá đã bao gồm VAT. Bạn có thể chọn thanh toán trả góp ở bước tiếp theo.</p>
            </div>
        </div>

        <aside class="cart-summary">
            <h2>Thông tin đơn hàng</h2>
            
            <!-- Hiển thị địa chỉ đã lưu nếu user đã đăng nhập -->
            <div th:if="${userAddresses != null and !userAddresses.empty}" class="saved-addresses" style="margin-bottom: 20px;">
                <h3>Địa chỉ nhận hàng</h3>
                <select id="addressId" name="addressId" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px;">
                    <option th:each="addr : ${userAddresses}" 
                            th:value="${addr.id}" 
                            th:text="${addr.fullAddress}"
                            th:selected="${addr.isDefault}">
                    </option>
                </select>
                <small><a href="/tai-khoan/dia-chi">Quản lý sổ địa chỉ</a></small>
            </div>
            
            <!-- Form nhập địa chỉ nếu chưa đăng nhập hoặc chưa có địa chỉ -->
            <form th:unless="${userAddresses != null and !userAddresses.empty}" class="guest-form" style="margin-bottom: 20px;">
                <label>Họ và tên
                    <input type="text" placeholder="Nguyễn Thị Minh" required>
                </label>
                <label>Số điện thoại
                    <input type="tel" placeholder="0901 234 567" required>
                </label>
                <label>Địa chỉ giao xe
                    <input type="text" placeholder="Số nhà, đường, quận/huyện, tỉnh/thành" required>
                </label>
            </form>
            
            <hr class="divider" style="border: 0; border-top: 1px solid #ddd; margin: 20px 0;">
            
            <!-- Phương thức vận chuyển -->
            <div class="shipping-method" style="margin-bottom: 20px;">
                <h3>Vận chuyển</h3>
                <label class="radio-card" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="deliveryMethod" value="STANDARD" checked onchange="updateShipping(0)">
                    <div class="card-content" style="display: flex; justify-content: space-between; width: 100%; font-size: 0.95rem;">
                        <span>Tiêu chuẩn (3-5 ngày)</span>
                        <strong>Miễn phí</strong>
                    </div>
                </label>
                <label class="radio-card" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="deliveryMethod" value="FAST" onchange="updateShipping(50000)">
                    <div class="card-content" style="display: flex; justify-content: space-between; width: 100%; font-size: 0.95rem;">
                        <span>Giao nhanh hỏa tốc (24h)</span>
                        <strong>50.000 ₫</strong>
                    </div>
                </label>
            </div>
            
            <!-- Mã giảm giá (Voucher) -->
            <div class="voucher-section" style="margin-bottom: 20px;">
                <h3>Mã ưu đãi</h3>
                <div class="voucher-input-group" style="display: flex; gap: 8px;">
                    <input type="text" id="voucherCode" placeholder="Nhập mã giảm giá" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    <button type="button" class="vf-btn vf-btn--ghost" onclick="openVoucherModal()" style="background: #f0f7ff; color: #0048ff; border: 1px solid #0048ff;">Chọn mã</button>
                    <button type="button" class="vf-btn vf-btn--primary" onclick="applyVoucher()">Áp dụng</button>
                </div>
                <p id="voucherMessage" class="text-success" style="margin-top: 8px; color: #00a86b; font-size: 0.9rem;"></p>
            </div>
            
            <!-- Tóm tắt đơn hàng -->
            <div class="summary-total">
                <div>
                    <span>Tạm tính</span>
                    <strong id="subtotal" th:text="${subtotal != null} ? ${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫' : '0 ₫'">0 ₫</strong>
                </div>
                <div>
                    <span>Phí vận chuyển</span>
                    <strong id="shippingFee">0 ₫</strong>
                </div>
                <div>
                    <span>Giảm giá</span>
                    <strong id="discountAmount">- 0 ₫</strong>
                </div>
                <div class="summary-grand">
                    <span>Tổng cộng</span>
                    <strong id="totalAmount" class="text-primary" th:text="${subtotal != null} ? ${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫' : '0 ₫'" style="color: #0048ff;">0 ₫</strong>
                </div>
            </div>
            
            <div class="payment-options" style="margin-top: 20px;">
                <h3>Phương thức thanh toán</h3>
                <label><input type="radio" name="pay" checked> Chuyển khoản ngân hàng</label>
                <label><input type="radio" name="pay"> Thẻ tín dụng / Ghi nợ</label>
                <label><input type="radio" name="pay"> Thanh toán tại showroom</label>
            </div>

            <button class="vf-btn vf-btn--primary" style="width: 100%; margin-top: 16px;" onclick="submitOrder()">Đặt mua ngay</button>
            <p class="secure-note" style="margin-top: 12px; font-size: 0.85rem; color: #888; text-align: center;">Hợp đồng sẽ được gửi tới email để xác nhận bằng OTP.</p>
        </aside>
    </section>

    <section class="vf-container faq" data-animate>
        <header class="section-header">
            <small>Giải đáp nhanh</small>
            <h2>Câu hỏi thường gặp</h2>
        </header>
        <div class="faq-grid">
            <article>
                <h3>Tôi cần chuẩn bị giấy tờ gì?</h3>
                <p>Chỉ cần CMND/CCCD và thông tin liên hệ để đối chiếu khi giao xe hoặc làm thủ tục vay.</p>
            </article>
            <article>
                <h3>Thanh toán trả góp thế nào?</h3>
                <p>Đại diện VinFast sẽ liên hệ để hỗ trợ thẩm định và ký hồ sơ với ngân hàng đối tác sau khi bạn gửi đơn đặt hàng.</p>
            </article>
            <article>
                <h3>Giỏ hàng có lưu lại khi tôi rời trang?</h3>
                <p>Hệ thống lưu tạm trên trình duyệt. Bạn có thể gửi link giỏ hàng cho tư vấn viên để được hỗ trợ nhanh hơn.</p>
            </article>
        </div>
    </section>

    <!-- Voucher Modal -->
    <div id="voucherModal" class="voucher-modal">
        <div class="voucher-modal-content">
            <div class="voucher-header">
                <h3>Chọn mã giảm giá</h3>
                <button class="close-modal" onclick="closeVoucherModal()">×</button>
            </div>
            <div class="voucher-list" id="voucherList">
                <!-- Voucher items will be injected here -->
                <p style="text-align: center; color: #888;">Đang tải...</p>
            </div>
        </div>
    </div>

</main>

<div th:replace="~{fragments/chan-trang :: chanTrang}"></div>

<script th:src="@{/js/dieu-huong.js}" src="/js/dieu-huong.js"></script>
<script>
    // Khởi tạo các giá trị ban đầu
    let currentSubtotal = parseFloat(document.getElementById('subtotal').innerText.replace(/[^\d]/g, '')) || 0;
    let currentShipping = 0;
    let currentDiscount = 0;
    let appliedVoucher = null;
    
    // Cập nhật phí vận chuyển
    function updateShipping(fee) {
        currentShipping = fee;
        updateTotal();
        document.getElementById('shippingFee').innerText = fee.toLocaleString('vi-VN') + ' ₫';
    }
    
    // Áp dụng mã giảm giá (Voucher)
    async function applyVoucher() {
        const code = document.getElementById('voucherCode').value.trim();
        const messageEl = document.getElementById('voucherMessage');
        
        if (!code) {
            messageEl.innerText = 'Vui lòng nhập mã giảm giá';
            messageEl.style.color = '#e53e3e';
            return;
        }
        
        try {
            // Gọi API kiểm tra voucher
            const response = await fetch('/api/vouchers/code/' + code);
            const data = await response.json();
            
            if (response.ok && data.valid) {
                // Tính toán giảm giá
                const voucher = data.voucher;
                let discount = 0;
                
                if (voucher.discountType === 'PERCENTAGE') {
                    // Giảm theo phần trăm
                    discount = currentSubtotal * (voucher.discountValue / 100);
                    if (voucher.maxDiscountAmount != null && discount > voucher.maxDiscountAmount) {
                        discount = voucher.maxDiscountAmount;
                    }
                } else if (voucher.discountType === 'FIXED') {
                    // Giảm cố định
                    discount = voucher.discountValue;
                    if (discount > currentSubtotal) {
                        discount = currentSubtotal;
                    }
                }
                
                currentDiscount = discount;
                appliedVoucher = voucher;
                updateTotal();
                
                messageEl.innerText = 'Đã áp dụng mã giảm giá: ' + voucher.code;
                messageEl.style.color = '#00a86b';
                document.getElementById('discountAmount').innerText = '- ' + discount.toLocaleString('vi-VN') + ' ₫';
            } else {
                messageEl.innerText = data.message || 'Mã giảm giá không hợp lệ';
                messageEl.style.color = '#e53e3e';
                currentDiscount = 0;
                appliedVoucher = null;
                updateTotal();
                document.getElementById('discountAmount').innerText = '- 0 ₫';
            }
        } catch (error) {
            console.error('Error applying voucher:', error);
            messageEl.innerText = 'Có lỗi xảy ra. Vui lòng thử lại.';
            messageEl.style.color = '#e53e3e';
        }
    }
    
    // Cập nhật tổng tiền
    function updateTotal() {
        const total = currentSubtotal + currentShipping - currentDiscount;
        document.getElementById('totalAmount').innerText = total.toLocaleString('vi-VN') + ' ₫';
    }
    
    // Cập nhật số lượng trong giỏ hàng
    async function updateCartQuantity(cartId, quantity) {
        try {
            const response = await fetch('/api/cart/' + cartId, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ quantity: parseInt(quantity) })
            });
            
            if (response.ok) {
                // Reload trang để cập nhật giá trị
                location.reload();
            } else {
                alert('Có lỗi xảy ra khi cập nhật số lượng');
            }
        } catch (error) {
            console.error('Error updating cart:', error);
            alert('Có lỗi xảy ra. Vui lòng thử lại.');
        }
    }
    
    // Xóa sản phẩm khỏi giỏ hàng
    async function removeFromCart(cartId) {
        if (!confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/cart/' + cartId, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                location.reload();
            } else {
                alert('Có lỗi xảy ra khi xóa sản phẩm');
            }
        } catch (error) {
            console.error('Error removing cart item:', error);
            alert('Có lỗi xảy ra. Vui lòng thử lại.');
        }
    }
    
    // Gửi đơn hàng
    async function submitOrder() {
        const addressId = document.getElementById('addressId')?.value;
        const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'STANDARD';
        const paymentMethod = document.querySelector('input[name="pay"]:checked')?.value || 'BANK_TRANSFER';
        
        // Validate
        if (!addressId) {
            alert('Vui lòng chọn địa chỉ nhận hàng');
            return;
        }
        
        try {
            // Gọi API tạo đơn hàng
            const orderData = {
                addressId: parseInt(addressId),
                deliveryMethod: deliveryMethod,
                paymentMethod: paymentMethod,
                voucherCode: appliedVoucher?.code || null,
                shippingFee: currentShipping,
                discount: currentDiscount
            };
            
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('Đặt hàng thành công! Mã đơn hàng: ' + data.orderCode);
                window.location.href = '/';
            } else {
                alert(data.message || 'Có lỗi xảy ra khi đặt hàng');
            }
        } catch (error) {
            console.error('Error submitting order:', error);
            alert('Có lỗi xảy ra. Vui lòng thử lại.');
        }
    }
    
    // Animation observer
    (function () {
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, { threshold: 0.2 });

        document.querySelectorAll('[data-animate]').forEach(el => observer.observe(el));
        
        // Cập nhật giá trị subtotal từ server nếu có
        const subtotalEl = document.getElementById('subtotal');
        if (subtotalEl) {
            currentSubtotal = parseFloat(subtotalEl.innerText.replace(/[^\d]/g, '')) || 0;
        }
    })();

    // Voucher Modal Logic
    const voucherModal = document.getElementById('voucherModal');
    const voucherList = document.getElementById('voucherList');

    function openVoucherModal() {
        voucherModal.classList.add('is-active');
        fetchVouchers();
    }

    function closeVoucherModal() {
        voucherModal.classList.remove('is-active');
    }

    // Close modal when clicking outside
    voucherModal.addEventListener('click', function(e) {
        if (e.target === voucherModal) {
            closeVoucherModal();
        }
    });

    async function fetchVouchers() {
        try {
            const response = await fetch('/api/vouchers/available');
            const vouchers = await response.json();
            
            voucherList.innerHTML = '';
            
            if (vouchers.length === 0) {
                voucherList.innerHTML = '<p style="text-align: center; color: #888;">Không có mã giảm giá nào khả dụng.</p>';
                return;
            }
            
            vouchers.forEach(voucher => {
                const isPercentage = voucher.discountType === 'PERCENTAGE';
                const discountText = isPercentage ? voucher.discountValue + '%' : parseFloat(voucher.discountValue).toLocaleString('vi-VN') + 'đ';
                
                // Check if valid for current order
                const isValid = !voucher.minOrderAmount || currentSubtotal >= voucher.minOrderAmount;
                
                const item = document.createElement('div');
                item.className = `voucher-item ${isValid ? '' : 'disabled'}`;
                item.innerHTML = `
                    <div class="voucher-info">
                        <h4>${voucher.code}</h4>
                        <p>${voucher.description || 'Giảm ' + discountText}</p>
                        <span class="voucher-expiry">HSD: ${new Date(voucher.endDate).toLocaleDateString('vi-VN')}</span>
                        ${!isValid ? `<br><small style="color: #e53e3e; margin-top: 4px; display: block;">Đơn tối thiểu ${parseFloat(voucher.minOrderAmount).toLocaleString('vi-VN')}đ</small>` : ''}
                    </div>
                    <div class="voucher-action">
                        <button class="btn-apply-voucher" onclick="selectVoucher('${voucher.code}')" ${isValid ? '' : 'disabled'}>Dùng ngay</button>
                    </div>
                `;
                voucherList.appendChild(item);
            });
        } catch (error) {
            console.error('Error fetching vouchers:', error);
            voucherList.innerHTML = '<p style="text-align: center; color: #e53e3e;">Có lỗi khi tải danh sách voucher.</p>';
        }
    }

    function selectVoucher(code) {
        document.getElementById('voucherCode').value = code;
        closeVoucherModal();
        applyVoucher(); // Auto apply
    }
</script>
</body>
</html>

