<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>
    
    <title th:text="${product != null ? product.name : 'Sản phẩm'}">Chi tiết sản phẩm</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" th:href="@{/css/trang-chu.css}">
    <link rel="stylesheet" th:href="@{/css/chi-tiet-san-pham.css}">
</head>
<body>

    <div th:replace="~{fragments/dieu-huong :: thanhDieuHuong}"></div>

    <div class="product-detail-wrapper">
        <div class="vf-container">
            <!-- Error State -->
            <div th:if="${product == null}" class="error-message">
                <h1>Sản phẩm không tồn tại</h1>
                <p>Sản phẩm bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
                <a href="/" class="vf-btn vf-btn--primary">Về trang chủ</a>
            </div>

            <!-- Product Content -->
            <div th:if="${product != null}">
                <!-- Breadcrumb -->
                <nav class="breadcrumb-nav animate-fade-in">
                    <a href="/">Trang chủ</a> / 
                    <a href="#">Sản phẩm</a> / 
                    <span th:text="${product.name}">Tên sản phẩm</span>
                </nav>

                <!-- Hero Highlights - Giống VinFast -->
                <div class="hero-highlights animate-fade-in-up delay-200">
                    <div class="highlight-item">
                        <span class="highlight-value">70 km/h</span>
                        <span class="highlight-label">Tốc độ tối đa</span>
                    </div>
                    <div class="highlight-item">
                        <span class="highlight-value">~262 km</span>
                        <span class="highlight-label">Quãng đường di chuyển</span>
                    </div>
                    <div class="highlight-item">
                        <span class="highlight-value">35 lít</span>
                        <span class="highlight-label">Dung tích cốp xe</span>
                    </div>
                    <div class="highlight-item">
                        <span class="highlight-value">15s</span>
                        <span class="highlight-label">Tăng tốc 0-50 km/h</span>
                    </div>
                </div>

                <!-- Product Hero -->
                <div class="product-hero">
                    <!-- Product Image -->
                    <div class="animate-slide-in-left">
                        <div class="product-image-wrapper">
                            <div th:if="${product.discountPrice != null}" class="product-badge">
                                Ưu đãi đặc biệt
                            </div>
                            <img id="mainProductImage" 
                                 th:src="${product.image}" 
                                 th:alt="${product.name}"
                                 onerror="this.src='https://placehold.co/600x400?text=VinFast'">
                        </div>
                        
                        <!-- Thumbnail Gallery -->
                        <div class="product-thumbnails animate-fade-in delay-300" th:if="${productImages != null and !productImages.isEmpty()}">
                            <div class="thumbnail-item" 
                                 th:each="img, iterStat : ${productImages}"
                                 th:classappend="${iterStat.first} ? 'active' : ''"
                                 th:data-image="${img}"
                                 onclick="changeMainImage(this.dataset.image, this)">
                                <img th:src="${img}" 
                                     th:alt="${product.name + ' - Ảnh ' + iterStat.count}"
                                     onerror="this.src='https://placehold.co/100x100?text=VinFast'">
                            </div>
                        </div>
                        
                        <div class="brand-tag animate-fade-in delay-300">
                            <strong>Thương hiệu: </strong>
                            <span th:text="${product.brandName != null and product.brandName != '' ? product.brandName : 'VinFast'}">VinFast</span>
                        </div>
                    </div>

                    <!-- Product Details -->
                    <div class="animate-slide-in-right">
                        <h1 class="product-title" th:text="${product.name}">Tên sản phẩm</h1>
                        
                        <div th:if="${product.description != null}" class="product-description animate-fade-in delay-200">
                            <p th:text="${product.description}">Mô tả sản phẩm</p>
                        </div>

                        <!-- Price -->
                        <div class="price-container animate-scale-in delay-300">
                            <div class="price-main">
                                <span th:text="${#numbers.formatDecimal(product.finalPrice, 0, 'COMMA', 0, 'POINT')}">0</span>
                                <span class="price-unit">VNĐ</span>
                            </div>
                            <div th:if="${product.discountPrice != null}" class="price-old animate-fade-in delay-400">
                                <span th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')}">0</span> VNĐ
                            </div>
                            <div class="price-note">
                                (Đã bao gồm VAT, 01 pin và 01 bộ sạc)
                            </div>
                        </div>

                        <!-- Stock Status -->
                        <div class="animate-fade-in delay-400">
                            <div th:if="${product.quantity != null && product.quantity > 0}" 
                                 class="stock-status in-stock">
                                <span>✓</span>
                                <span>Còn hàng</span>
                            </div>
                            <div th:unless="${product.quantity != null && product.quantity > 0}" 
                                 class="stock-status out-of-stock">
                                <span>✖</span>
                                <span>Tạm hết hàng</span>
                            </div>
                        </div>

                        <!-- Add to Cart -->
                        <div class="animate-fade-in delay-500 cta-group">
                            <div class="quantity-selector">
                                <label>Số lượng:</label>
                                <input type="number" 
                                       id="qtyInput" 
                                       value="1" 
                                       min="1" 
                                       max="10"
                                       class="quantity-input">
                            </div>
                            
                            <button type="button" 
                                    class="btn-buy-now"
                                    th:disabled="${product.quantity == null || product.quantity <= 0}"
                                    onclick="addToCart()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                                    <line x1="3" y1="6" x2="21" y2="6"></line>
                                    <path d="M16 10a4 4 0 0 1-8 0"></path>
                                </svg>
                                <span>Mua Ngay</span>
                            </button>
                            
                            <button type="button" 
                                    class="btn-installment"
                                    onclick="alert('Tính năng đang phát triển')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                    <line x1="1" y1="10" x2="23" y2="10"></line>
                                </svg>
                                <span>Mua trả góp</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Specifications - Thông số kỹ thuật mẫu -->
                <div class="specs-section animate-fade-in-up delay-400">
                    <h2 class="specs-title">THÔNG SỐ KỸ THUẬT</h2>
                    
                    <div class="specs-grid">
                        <!-- Kích thước & Trọng lượng -->
                        <div class="specs-category animate-fade-in delay-500">
                            <h3 class="specs-category-title">Kích thước & Trọng lượng</h3>
                            <div class="specs-list">
                                <div class="spec-item">
                                    <span class="spec-label">Dài x Rộng x Cao (mm)</span>
                                    <span class="spec-value">1858 x 690 x 1100</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Khoảng cách trục bánh</span>
                                    <span class="spec-value">1295 mm</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Khoảng sáng gầm</span>
                                    <span class="spec-value">133 mm</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Chiều cao yên</span>
                                    <span class="spec-value">770 mm</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Thể tích cốp</span>
                                    <span class="spec-value">35L (16L khi lắp pin phụ)</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Kích thước lốp Trước - Sau</span>
                                    <span class="spec-value">90/90-12 | 90/90-12</span>
                                </div>
                            </div>
                        </div>

                        <!-- Động cơ & Hiệu suất -->
                        <div class="specs-category animate-fade-in delay-600">
                            <h3 class="specs-category-title">Động cơ & Hiệu suất</h3>
                            <div class="specs-list">
                                <div class="spec-item">
                                    <span class="spec-label">Công suất danh định</span>
                                    <span class="spec-value">1500 W</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Công suất tối đa</span>
                                    <span class="spec-value">2250 W</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Loại động cơ</span>
                                    <span class="spec-value">BLDC Inhub</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Tốc độ tối đa</span>
                                    <span class="spec-value">70 km/h</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Gia tốc 0 - 50 km/h</span>
                                    <span class="spec-value">&lt;15s</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Giảm xóc trước và sau</span>
                                    <span class="spec-value">Ống lồng - Giảm chấn thủy lực</span>
                                </div>
                            </div>
                        </div>

                        <!-- Pin & Sạc -->
                        <div class="specs-category animate-fade-in delay-500">
                            <h3 class="specs-category-title">Pin & Sạc</h3>
                            <div class="specs-list">
                                <div class="spec-item">
                                    <span class="spec-label">Dung lượng pin</span>
                                    <span class="spec-value">2.4 kWh (Tùy chọn thêm 1 pin 2.4 kWh)</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Loại pin</span>
                                    <span class="spec-value">LFP</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Trọng lượng pin</span>
                                    <span class="spec-value">18 kg</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Thời gian sạc tiêu chuẩn</span>
                                    <span class="spec-value">Khoảng 6h30 phút từ 0 - 100%</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Quãng đường đi được 1 lần sạc</span>
                                    <span class="spec-value">Khoảng 134 km (+128 km khi lắp thêm pin phụ)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tính năng & An toàn -->
                        <div class="specs-category animate-fade-in delay-600">
                            <h3 class="specs-category-title">Tính năng & An toàn</h3>
                            <div class="specs-list">
                                <div class="spec-item">
                                    <span class="spec-label">Hệ thống phanh</span>
                                    <span class="spec-value">Phanh đĩa trước, Phanh tang trống sau</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Khóa xe</span>
                                    <span class="spec-value">Khóa thông minh (Smart Key)</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Màn hình</span>
                                    <span class="spec-value">Màn hình TFT hiện đại</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Chống nước</span>
                                    <span class="spec-value">Tiêu chuẩn IP67</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Kết nối</span>
                                    <span class="spec-value">PAAK, App điện thoại, Esim</span>
                                </div>
                                <div class="spec-item">
                                    <span class="spec-label">Màu sắc</span>
                                    <span class="spec-value">Xanh Rêu, Xanh Oliu, Đen nhám, Trắng Ngọc Trai</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/chan-trang :: chanTrang}"></div>

    <script>
        // Intersection Observer for scroll animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0) translateX(0)';
                }
            });
        }, observerOptions);

        // Observe all animated elements
        document.addEventListener('DOMContentLoaded', () => {
            const animatedElements = document.querySelectorAll('.animate-fade-in-up, .animate-slide-in-left, .animate-slide-in-right, .animate-scale-in');
            animatedElements.forEach(el => observer.observe(el));
            
            // Add float animation to highlight items
            const highlightItems = document.querySelectorAll('.highlight-item');
            highlightItems.forEach((item, index) => {
                item.style.animationDelay = `${index * 0.1}s`;
                item.style.animation = `float 3s ease-in-out infinite`;
            });
        });
        
        // Change main product image when clicking thumbnail
        function changeMainImage(imageUrl, clickedThumbnail) {
            const mainImage = document.getElementById('mainProductImage');
            if (mainImage) {
                mainImage.src = imageUrl;
                // Update active state
                document.querySelectorAll('.thumbnail-item').forEach(item => {
                    item.classList.remove('active');
                });
                clickedThumbnail.classList.add('active');
            }
        }

        // Add to Cart Function
        function addToCart() {
            var productId = /*[[${product != null ? product.id : null}]]*/ null;
            if (!productId) {
                alert('Không tìm thấy thông tin sản phẩm');
                return;
            }
            
            var quantity = document.getElementById('qtyInput').value;
            var userId = 1; // TODO: Lấy từ session
            
            var csrfToken = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
            var csrfHeader = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");
            
            var headers = { 
                'Content-Type': 'application/json' 
            };
            
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            // Disable button during request
            var btn = event.target.closest('.btn-buy-now') || event.target;
            btn.disabled = true;
            var btnSpan = btn.querySelector('span');
            if (btnSpan) {
                btnSpan.textContent = 'Đang xử lý...';
            } else {
                btn.textContent = 'Đang xử lý...';
            }

            fetch('/api/cart/add', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    userId: userId,
                    productId: productId,
                    quantity: parseInt(quantity),
                    colorId: null
                })
            })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => { throw new Error(text || res.statusText) });
                }
                return res.json();
            })
            .then(data => {
                if(data.success) {
                    // Success animation
                    var btnSpan = btn.querySelector('span');
                    if (btnSpan) {
                        btnSpan.textContent = '✓ Đã thêm!';
                    } else {
                        btn.textContent = '✓ Đã thêm!';
                    }
                    btn.style.background = 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)';
                    setTimeout(() => {
                        btn.disabled = false;
                        if (btnSpan) {
                            btnSpan.textContent = 'Mua Ngay';
                        } else {
                            btn.textContent = 'Mua Ngay';
                        }
                        btn.style.background = '';
                    }, 2000);
                } else {
                    alert('Lỗi: ' + (data.message || 'Không xác định'));
                    btn.disabled = false;
                    var btnSpan = btn.querySelector('span');
                    if (btnSpan) {
                        btnSpan.textContent = 'Mua Ngay';
                    } else {
                        btn.textContent = 'Mua Ngay';
                    }
                }
            })
            .catch(err => {
                console.error("Lỗi:", err);
                alert('Có lỗi xảy ra khi thêm vào giỏ hàng.');
                btn.disabled = false;
                var btnSpan = btn.querySelector('span');
                if (btnSpan) {
                    btnSpan.textContent = 'Mua Ngay';
                } else {
                    btn.textContent = 'Mua Ngay';
                }
            });
        }
    </script>
    
    <script th:src="@{/js/dieu-huong.js}"></script>

</body>
</html>
